#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  aws ec2 describe-instances | \
    jq '
        def kv (k):
          if type == "array" then
            []
          elif type == "object" then
            to_entries | map(["\(k)_\(.key)", .value])[]
          else
            [ k, . ]
          end;

        .Reservations[].Instances | 
        
        map({
          key: .PrivateIpAddress, 
          value: 
            (to_entries | 
            map("\(.key)" as $k | .value | kv($k)) |
            map(select(length > 0)) |
            map({key: .[0], value: .[1]}) |
            from_entries)
        }) |

        {_meta: {hostvars: from_entries }}
  '
}

source sub-chain "$BASH_SOURCE" "$@"
